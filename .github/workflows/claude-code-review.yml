name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review')) ||
      (
        github.event_name == 'pull_request' &&
        !github.event.pull_request.draft &&
        !contains(github.event.pull_request.title, '[skip review]') &&
        !contains(github.event.pull_request.title, '[WIP]') &&
        !contains(github.event.pull_request.title, '[wip]') &&
        !(github.event.pull_request.head.ref == 'release-candidate' && github.event.pull_request.base.ref == 'main')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # コードレビューガイドライン
            ## 概要
            あなたの役割は、非常に経験豊富なソフトウェアエンジニアとして、コードの一部を徹底的にレビューし、以下の観点から問題を検出し、具体的な改善案を提供することです：

            ### 重要度：高（必ず指摘）
              - **動作しないコード**: 構文エラー、未定義変数、型エラー、ヌルポインタ参照の可能性
              - **ロジックエラー**: 無限ループ、到達不可能なコード、条件分岐の誤り
              - **セキュリティ脆弱性**: SQLインジェクション、XSS、CSRF、認証・認可の問題
              - **重大なパフォーマンス問題**: N+1クエリ、メモリリーク、非効率なアルゴリズム
              - **データ競合**: 競合状態、デッドロック、不適切な並行処理

            ### レビュー方針
              - コードが正しく動作するかを最優先で判定してください
              - 軽微なコードスタイルの問題は無視してください
              - 「問題ありません」のようなコメントは避けてください


            ## 望んでいるレビューの出力結果

            最終的にコードが動くアプリケーションになっているか、Markdown形式でPRにコメントを追加してください。
            - 動作しないコードやロジックエラーがないか
            - Ruby on Railsベストプラクティスに従っているか
            - 各項目について、問題があれば具体的に指摘し、なければ「問題ありません」と記載してください。
            - 「```」のコードブロックは不要です。
